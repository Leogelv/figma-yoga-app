# Архитектура Yoga & Meditation App

## Общее описание

Yoga & Meditation App - это мини-приложение для Telegram, которое помогает пользователям подбирать подходящие практики йоги, медитации и дыхательных упражнений на основе их индивидуальных предпочтений, целей и уровня подготовки. Приложение представляет собой интерактивный квиз, который ведет пользователя через серию вопросов, а затем рекомендует подходящие практики.

## Технологический стек

### Frontend
- **Framework**: Next.js 13.5.6 + TypeScript
- **Стили**: TailwindCSS 3.3.0 
- **UI компоненты**: Самописные компоненты с применением Tailwind
- **Иконки**: Lucide React
- **Утилиты**: clsx, tailwind-merge

### Backend (планируемый)
- **База данных**: Supabase (PostgreSQL)
- **Аутентификация**: Telegram Mini Apps API
- **Хранение медиа**: Supabase Storage
- **Веб-сервисы**: Next.js API Routes

## Структура проекта (обновлено)

### Директории
- `/app` - Основные страницы приложения
  - `/app/page.tsx` - Главная страница (будущий дашборд)
  - `/app/quiz/page.tsx` - Квиз для подбора практики
- `/components` - Компоненты приложения
  - `/components/ui` - Базовые UI компоненты
    - `/components/ui/button` - Кнопки и связанные компоненты
    - `/components/ui/layout` - Компоненты лейаута
    - `/components/ui/loading` - Лоадеры и спиннеры
  - `/components/quiz` - Компоненты, связанные с квизом
    - `/components/quiz/core` - Основные компоненты для квиза (Option и т.д.)
    - `/components/quiz/steps` - Шаги квиза (разделены по типам практик)
  - `/components/practice` - Компоненты для отображения практик
    - `/components/practice/timer` - Компоненты таймера практик
- `/context` - React Context провайдеры
- `/lib` - Вспомогательные функции и утилиты
- `/public` - Статические файлы (изображения и т.д.)
- `/types` - TypeScript интерфейсы и типы

### Поток приложения
1. Пользователь начинает с выбора типа практики (йога, медитация, дыхание)
2. Последовательно проходит шаги квиза для выбранного типа
3. После завершения квиза система автоматически подбирает подходящую практику
4. Пользователю сразу отображается PracticeScreen, который:
   - Для медитаций: показывает видеоплеер (Kinescope)
   - Для йоги/растяжки/дыхания: показывает таймер с круговым прогрессом
5. Пользователь может:
   - Завершить практику
   - Отменить и вернуться к квизу
   - Попробовать другую практику (перезапуск рандомайзера)

## Основные компоненты

### UI компоненты
- `Button` - Кнопка с различными вариантами стилей и размеров
- `Spinner` - Индикатор загрузки
- `QuizLayout` - Базовый лейаут для экранов квиза

### Квиз-компоненты
- `TypeSelectionStep` - Выбор типа практики
- `*Steps` - Различные шаги квиза в зависимости от типа практики

### Практика-компоненты
- `PracticeScreen` - Универсальный компонент для отображения практик
  - Определяет тип практики и отображает соответствующий интерфейс
  - Обрабатывает завершение, отмену и запрос другой практики

## Контекст и стейт-менеджмент
- `PracticeFlowContext` - Хранит состояние прохождения квиза
  - Хранит выбранные параметры для каждого типа практики
  - Содержит историю исключенных практик
  - Предоставляет функции навигации между шагами

## Организация компонентов
Компоненты структурированы по принципу модульности и ответственности:
- UI компоненты обеспечивают базовые блоки интерфейса
- Компоненты квиза отвечают за логику анкетирования
- Компоненты практик управляют отображением и взаимодействием с практиками

## Дорожная карта разработки
1. Интеграция с Telegram Mini Apps API
2. Добавление функционала сохранения предпочтений пользователя
3. Быстродействие и отзывчивость приложения
4. Расширение базы практик и типов упражнений

## Основные компоненты

### UI компоненты
- `Button` - Кнопка с различными вариантами стилей и размеров
- `Spinner` - Индикатор загрузки
- `QuizLayout` - Базовый лейаут для экранов квиза

### Квиз-компоненты
- `TypeSelectionStep` - Выбор типа практики
- `*Steps` - Различные шаги квиза в зависимости от типа практики

### Практика-компоненты
- `PracticeScreen` - Универсальный компонент для отображения практик
  - Определяет тип практики и отображает соответствующий интерфейс
  - Обрабатывает завершение, отмену и запрос другой практики

## Контекст и стейт-менеджмент
- `PracticeFlowContext` - Хранит состояние прохождения квиза
  - Хранит выбранные параметры для каждого типа практики
  - Содержит историю исключенных практик
  - Предоставляет функции навигации между шагами

## Организация компонентов

### UI Компоненты (components/ui)

Базовые UI компоненты, независимые от бизнес-логики приложения:

1. **Button** (ui/button/Button.tsx)
   - Универсальный компонент кнопки, заменяющий QuizButton
   - Поддерживает различные варианты вида (primary, secondary, etc.)
   - Принимает параметр size (sm, md, lg)
   - Использует utility-first подход (tailwind)

2. **Spinner** (ui/loading/Spinner.tsx)
   - Компонент индикатора загрузки, заменяющий LoadingSpinner
   - Настраиваемый размер и цвет

3. **ContentSafeAreaWrapper** (ui/layout/ContentSafeAreaWrapper.tsx)
   - Обертка с учетом безопасных областей для мобильных устройств
   - Адаптируется под Telegram Mini Apps

### Компоненты квиза (components/quiz)

Компоненты, специфичные для функциональности квиза:

1. **Базовые компоненты квиза** (core/)
   - QuizLayout - базовая структура для всех экранов квиза
   - QuizOption - компонент для отображения опций выбора

2. **Шаги квиза** (steps/)
   - Компоненты для каждого этапа квиза, разделенные по категориям:
     - TypeSelectionStep - выбор типа практики
     - Шаги для телесных практик (body/)
     - Шаги для медитации (meditation/)
     - Шаги для дыхания (breathing/)

3. **RecommendationScreen**
   - Отображение рекомендаций практик на основе выборов пользователя

### Компоненты практики (components/practice)

Компоненты для выполнения выбранной практики:

1. **TimerScreen** (practice/timer/TimerScreen.tsx)
   - Интерактивный таймер для практик без видео
   - Отображает прогресс, позволяет ставить на паузу

2. **PracticePlayer** (practice/player/PracticePlayer.tsx)
   - Интеграция с Kinescope для видео-практик
   - Полноэкранный режим

## Архитектурные принципы

1. **Разделение ответственности**
   - UI компоненты отделены от бизнес-логики
   - Компоненты домена сгруппированы по функциональности (квиз, практика)
   - Контексты отвечают за хранение состояния и логику переходов

2. **Переиспользуемость**
   - Базовые UI компоненты (Button, Spinner) созданы для многократного использования
   - Каждый компонент выполняет одну конкретную задачу

3. **Консистентность**
   - Единый подход к наименованиям компонентов
   - Сходная структура папок для компонентов одного типа
   - Общие стили через tailwind с общими utility-классами

4. **Модульность**
   - Каждый компонент живет в своей папке
   - Связанные компоненты группируются в соответствующих директориях
   - Лимит 400-700 строк на файл

## Миграция со старой структуры

В процессе миграции со старой структуры:

1. **Этап 1 (завершен)**
   - Создана новая структура папок
   - Перенесены базовые UI компоненты
   - Добавлено свойство size в Button

2. **Этап 2 (в процессе)**
   - Перенос оставшихся компонентов из quiz-flow и practice-flow
   - Обновление импортов
   - Тестирование функциональности

3. **Этап 3 (планируется)**
   - Удаление устаревших компонентов и директорий
   - Полное обновление документации
   - Добавление комментариев к компонентам на русском языке

## Последняя верификация архитектуры

**Дата**: 03.11.2023
**Статус**: Архитектура в процессе реструктуризации, базовые компоненты перенесены, обновление импортов в процессе.

## Интеграция с Supabase (План)

### База данных

#### Таблицы

1. **practices**
   ```sql
   CREATE TABLE practices (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     name TEXT NOT NULL,
     type TEXT NOT NULL, -- 'body', 'meditation', 'breathing'
     description TEXT,
     duration TEXT, -- формат 'MM:SS'
     difficulty TEXT, -- 'beginner', 'intermediate', 'advanced'
     tags TEXT[],
     category TEXT,
     image_url TEXT,
     video_url TEXT,
     created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
     updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
   );
   ```

2. **user_profiles**
   ```sql
   CREATE TABLE user_profiles (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     telegram_id TEXT UNIQUE NOT NULL,
     username TEXT,
     preferences JSONB,
     created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
     updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
   );
   ```

3. **user_sessions**
   ```sql
   CREATE TABLE user_sessions (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     user_id UUID REFERENCES user_profiles(id),
     practice_id UUID REFERENCES practices(id),
     duration INTEGER, -- в секундах
     completed BOOLEAN DEFAULT false,
     created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
   );
   ```

### Аутентификация

Интеграция с Telegram Mini Apps API:
1. Получение данных пользователя через `initData`
2. Валидация данных на стороне сервера
3. Создание или обновление профиля пользователя в Supabase

### Edge Functions

1. **fetchRecommendations**
   - Получает рекомендации по параметрам квиза
   - Фильтрует практики по типу, длительности, уровню сложности и т.д.

2. **trackCompletion**
   - Отслеживает завершение практики пользователем
   - Обновляет статистику пользователя

3. **updateProfile**
   - Обновляет предпочтения пользователя

## Диаграмма потока пользователя

Поток пользователя строго соответствует диаграмме в `diagram.json`:

1. Главный экран → Выбор типа практики
2. Для каждого типа практики - свой поток:
   - **Телесные**: Тип телесной практики → Продолжительность → Цель → Результат
   - **Дыхательные**: Подход к дыханию → Результат
   - **Медитация**: 
     - Путь "Самостоятельная" → Объект медитации → Таймер
     - Путь "С сопровождением" → Цель медитации → Тема → Таймер

## Проблемы и дальнейшие улучшения

1. **Производительность**
   - Оптимизация загрузки компонентов (React.lazy, динамический импорт)
   - Кэширование данных API

2. **Доступность**
   - Улучшение a11y для всех компонентов
   - Поддержка режима высокой контрастности

3. **Оффлайн режим**
   - Использование Service Workers для кэширования и оффлайн доступа
   - Локальное сохранение прогресса пользователя

4. **Многоязычность**
   - Подготовка к поддержке нескольких языков через i18n

5. **Аналитика**
   - Внедрение аналитики Telegram Mini Apps
   - Отслеживание конверсии и завершения практик

## Дорожная карта разработки

### Спринт 1: Квиз подбора практики ✅
- Создание контекста для хранения состояния подбора
- Разработка компонентов для шагов квиза
- Реализация логики перехода между шагами
- Создание базовых UI-компонентов

### Спринт 2: Рекомендательная система 🟡
- Создание страниц рекомендаций практик
- Реализация таймера для практик
- Интеграция с Telegram Mini Apps API
- Создание страниц с описанием каждого типа практик

### Спринт 3: Персонализация и улучшения 🔴
- Добавление системы избранных практик
- Добавление истории практик
- Улучшение UI/UX на основе обратной связи
- Оптимизация производительности

### Спринт 4: Расширение функционала 🔴
- Добавление новых типов практик
- Интеграция с календарем
- Реализация напоминаний
- Добавление аналитики для пользователя

## Ключевые метрики успеха
- Количество завершенных квизов
- Время, проведенное в практиках
- Регулярность использования приложения
- Разнообразие выбранных практик

## Технические ограничения
- Приложение должно быть оптимизировано для мобильных устройств
- Интерфейс должен учитывать ограничения Telegram Mini Apps
- Максимальный размер приложения должен быть минимизирован для быстрой загрузки

## Приоритеты развития
1. Функциональность подбора практик
2. Удобство использования и интуитивность интерфейса
3. Быстродействие и отзывчивость приложения
4. Расширение базы практик и типов упражнений

