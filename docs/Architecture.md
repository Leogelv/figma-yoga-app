# Архитектура Yoga & Meditation App

## Общее описание

Yoga & Meditation App - это мини-приложение для Telegram, которое помогает пользователям подбирать подходящие практики йоги, медитации и дыхательных упражнений на основе их индивидуальных предпочтений, целей и уровня подготовки. Приложение представляет собой интерактивный квиз, который ведет пользователя через серию вопросов, а затем рекомендует подходящие практики.

## Технологический стек

### Frontend
- **Framework**: Next.js 13.5.6 + TypeScript
- **Стили**: TailwindCSS 3.3.0 
- **UI компоненты**: Самописные компоненты с применением Tailwind
- **Иконки**: Lucide React
- **Утилиты**: clsx, tailwind-merge

### Backend (планируемый)
- **База данных**: Supabase (PostgreSQL)
- **Аутентификация**: Telegram Mini Apps API
- **Хранение медиа**: Supabase Storage
- **Веб-сервисы**: Next.js API Routes

## Структура проекта (обновлено)

### Директории
- `/app` - Основные страницы приложения
  - `/app/page.tsx` - Главная страница (будущий дашборд)
  - `/app/quiz/page.tsx` - Квиз для подбора практики
- `/components` - Компоненты приложения
  - `/components/ui` - Базовые UI компоненты
    - `/components/ui/button` - Кнопки и связанные компоненты
    - `/components/ui/layout` - Компоненты лейаута
    - `/components/ui/loading` - Лоадеры и спиннеры
  - `/components/quiz` - Компоненты, связанные с квизом
    - `/components/quiz/core` - Основные компоненты для квиза (Option и т.д.)
    - `/components/quiz/steps` - Шаги квиза (разделены по типам практик)
  - `/components/practice` - Компоненты для отображения практик
    - `/components/practice/timer` - Компоненты таймера практик
- `/context` - React Context провайдеры
- `/lib` - Вспомогательные функции и утилиты
- `/public` - Статические файлы (изображения и т.д.)
- `/types` - TypeScript интерфейсы и типы

### Поток приложения
1. Пользователь начинает с выбора типа практики (йога, медитация, дыхание)
2. Последовательно проходит шаги квиза для выбранного типа
3. После завершения квиза система автоматически подбирает подходящую практику
4. Пользователю сразу отображается PracticeScreen, который:
   - Для телесных и дыхательных практик: показывает видеоплеер Kinescope (если есть видео)
   - Для медитаций: показывает таймер с круговым прогрессом 
   - Для всех практик без видео: таймер
5. Пользователь может:
   - Завершить практику
   - Отменить и вернуться к квизу
   - Попробовать другую практику (перезапуск рандомайзера)

## Экраны приложения

### 1. Главная страница (app/page.tsx)
**Описание**: Стартовый экран, с которого начинается взаимодействие с приложением
**UI-элементы**:
- Заголовок приложения
- Кнопка "Начать квиз"
- (Планируется) Кнопка быстрого старта практики
- (Планируется) Последние выполненные практики

**Навигация**:
- Вперед: Переход к экрану выбора типа практики
- Назад: Выход из приложения

### 2. Экран выбора типа практики (components/quiz/steps/TypeSelectionStep.tsx)
**Описание**: Пользователь выбирает тип практики (телесная, медитация, дыхание)
**UI-элементы**:
- Заголовок "Выберите тип практики"
- Карточки с типами практик
- Кнопка назад (возврат на главную)

**Навигация**:
- Вперед: При выборе типа практики переход к соответствующему первому шагу:
  - Телесная → BodyTypeStep
  - Медитация → PathSelectionStep
  - Дыхание → BreathingGoalStep
- Назад: Возврат на главную страницу

### 3. Шаги квиза для телесной практики

#### 3.1 Выбор типа телесной практики (components/quiz/steps/body/BodyTypeStep.tsx)
**Описание**: Выбор конкретного типа телесной практики (йога/растяжка)
**UI-элементы**:
- Заголовок "Выберите тип"
- Карточки с типами (йога, растяжка)
- Кнопка назад

**Навигация**:
- Вперед: При выборе переход к DifficultyStep
- Назад: Возврат к экрану выбора типа практики

#### 3.2 Выбор уровня сложности (components/quiz/steps/body/DifficultyStep.tsx)
**Описание**: Выбор уровня сложности практики
**UI-элементы**:
- Заголовок "Выберите уровень сложности"
- Опции с уровнями (начинающий, средний, продвинутый)
- Кнопка назад

**Навигация**:
- Вперед: При выборе переход к DurationStep
- Назад: Возврат к BodyTypeStep

#### 3.3 Выбор длительности (components/quiz/steps/body/DurationStep.tsx)
**Описание**: ПРОБЛЕМА - Пустой экран. Выбор длительности практики
**UI-элементы** (должны быть, но не отображаются):
- Заголовок "Выберите длительность практики"
- Опции длительности (короткая, средняя, длинная)
- Кнопка назад

**Навигация**:
- Вперед: При выборе переход к GoalStep
- Назад: Возврат к DifficultyStep

#### 3.4 Выбор цели (components/quiz/steps/body/GoalStep.tsx)
**Описание**: Выбор цели практики
**UI-элементы**:
- Заголовок "Выберите цель практики"
- Опции целей (расслабление, гибкость, сила и т.д.)
- Кнопка назад

**Навигация**:
- Вперед: При выборе переход к экрану практики (PracticeScreen)
- Назад: Возврат к DurationStep

### 4. Шаги квиза для медитации

#### 4.1 Выбор пути медитации (components/quiz/steps/meditation/PathSelectionStep.tsx)
**Описание**: Выбор между самостоятельной и сопровождаемой медитацией
**UI-элементы**:
- Заголовок "Выберите путь медитации"
- Опции (с сопровождением, самостоятельная)
- Кнопка назад

**Навигация**:
- Вперед: 
  - "С сопровождением" → MeditationGoalStep
  - "Самостоятельная" → ObjectSelectionStep
- Назад: Возврат к экрану выбора типа практики

#### 4.2а Выбор цели (для сопровождаемой) (components/quiz/steps/meditation/GoalStep.tsx)
**Описание**: Выбор цели медитации
**UI-элементы**:
- Заголовок "Выберите цель медитации"
- Опции целей (релаксация, концентрация и т.д.)
- Кнопка назад

**Навигация**:
- Вперед: При выборе переход к ThemeSelectionStep
- Назад: Возврат к PathSelectionStep

#### 4.2б Выбор темы (components/quiz/steps/meditation/ThemeSelectionStep.tsx)
**Описание**: Выбор тематики медитации
**UI-элементы**:
- Заголовок "Выберите тему медитации"
- Опции тем (природа, звуки и т.д.)
- Кнопка назад

**Навигация**:
- Вперед: При выборе переход к MeditationDurationStep
- Назад: Возврат к MeditationGoalStep

#### 4.2в Выбор длительности (components/quiz/steps/meditation/DurationStep.tsx)
**Описание**: Выбор длительности медитации
**UI-элементы**:
- Заголовок "Выберите длительность медитации"
- Опции длительности (короткая, средняя, длинная)
- Кнопка назад

**Навигация**:
- Вперед: При выборе переход к экрану практики (PracticeScreen)
- Назад: Возврат к ThemeSelectionStep

#### 4.3 Выбор объекта (для самостоятельной) (components/quiz/steps/meditation/ObjectSelectionStep.tsx)
**Описание**: Выбор объекта медитации
**UI-элементы**:
- Заголовок "Выберите объект медитации"
- Опции объектов (дыхание, тело, мысли и т.д.)
- Кнопка назад

**Навигация**:
- Вперед: При выборе переход к экрану практики (PracticeScreen)
- Назад: Возврат к PathSelectionStep

### 5. Шаги квиза для дыхательной практики

#### 5.1 Выбор цели (components/quiz/steps/breathing/GoalStep.tsx)
**Описание**: Выбор цели дыхательной практики
**UI-элементы**:
- Заголовок "Выберите цель дыхательной практики"
- Опции целей (энергия, расслабление и т.д.)
- Кнопка назад

**Навигация**:
- Вперед: При выборе переход к IntensityStep
- Назад: Возврат к экрану выбора типа практики

#### 5.2 Выбор интенсивности (components/quiz/steps/breathing/IntensityStep.tsx)
**Описание**: Выбор интенсивности дыхательной практики
**UI-элементы**:
- Заголовок "Выберите интенсивность практики"
- Опции интенсивности (мягкая, средняя, интенсивная)
- Кнопка назад

**Навигация**:
- Вперед: При выборе переход к BreathingDurationStep
- Назад: Возврат к BreathingGoalStep

#### 5.3 Выбор длительности (components/quiz/steps/breathing/DurationStep.tsx)
**Описание**: Выбор длительности дыхательной практики
**UI-элементы**:
- Заголовок "Выберите длительность практики"
- Опции длительности (короткая, средняя, длинная)
- Кнопка назад

**Навигация**:
- Вперед: При выборе переход к экрану практики (PracticeScreen)
- Назад: Возврат к IntensityStep

### 6. Экран практики (components/practice/PracticeScreen.tsx)
**Описание**: Отображение выбранной практики
**UI-элементы**:
- Заголовок с названием практики
- Подзаголовок с типом практики
- Видеоплеер Kinescope (для телесных и дыхательных практик с видео)
- Таймер в виде круга (для медитаций и практик без видео)
- Описание практики
- Информация о длительности и сложности
- Кнопки управления:
  - Пауза/Продолжить (для таймера)
  - Другая практика
  - Закончить

**Навигация**:
- Кнопка "Закончить": Возврат к последнему шагу квиза
- Кнопка "Другая практика": Перезапуск поиска практики

## Основные компоненты

### UI компоненты
- `Button` - Кнопка с различными вариантами стилей и размеров
- `Spinner` - Индикатор загрузки
- `QuizLayout` - Базовый лейаут для экранов квиза

### Квиз-компоненты
- `TypeSelectionStep` - Выбор типа практики
- `*Steps` - Различные шаги квиза в зависимости от типа практики

### Практика-компоненты
- `PracticeScreen` - Универсальный компонент для отображения практик
  - Определяет тип практики и отображает соответствующий интерфейс
  - Для телесных и дыхательных практик с видео: видеоплеер Kinescope
  - Для медитаций и практик без видео: таймер с круговым прогрессом
  - Обрабатывает завершение, отмену и запрос другой практики

## Навигация и состояние приложения

### Система навигации
- **Прямая навигация** - Переходы "вперед" между шагами квиза инициируются выбором пользователя
- **Обратная навигация** - Кнопка "назад" на всех экранах возвращает к предыдущему шагу

### Проблемы в навигации
**ВАЖНО**: Обнаружена проблема - кнопки "назад" и "отмена" не срабатывают на всех экранах. Необходимо проверить реализацию обработчиков `onBack` и `prevStep` в PracticeFlowContext.

### Управление состоянием
- **PracticeFlowContext** управляет всем состоянием квиза и навигацией между шагами
- Состояние включает:
  - Текущий тип практики
  - Параметры выбора для каждого типа практики
  - Историю исключенных практик 
  - Функции навигации:
    - `nextStep` - переход к следующему шагу
    - `prevStep` - возврат к предыдущему шагу (проблемная функция)
    - `resetFlow` - сброс к начальному состоянию

## Контекст и стейт-менеджмент
- `PracticeFlowContext` - Хранит состояние прохождения квиза
  - Хранит выбранные параметры для каждого типа практики
  - Содержит историю исключенных практик
  - Предоставляет функции навигации между шагами

## Организация компонентов
Компоненты структурированы по принципу модульности и ответственности:
- UI компоненты обеспечивают базовые блоки интерфейса
- Компоненты квиза отвечают за логику анкетирования
- Компоненты практик управляют отображением и взаимодействием с практиками

## Дорожная карта разработки
1. Интеграция с Telegram Mini Apps API
2. Добавление функционала сохранения предпочтений пользователя
3. Быстродействие и отзывчивость приложения
4. Расширение базы практик и типов упражнений

## Организация UI-компонентов

### UI Компоненты (components/ui)

Базовые UI компоненты, независимые от бизнес-логики приложения:

1. **Button** (ui/button/Button.tsx)
   - Универсальный компонент кнопки, заменяющий QuizButton
   - Поддерживает различные варианты вида (primary, secondary, etc.)
   - Принимает параметр size (sm, md, lg)
   - Использует utility-first подход (tailwind)

2. **Spinner** (ui/loading/Spinner.tsx)
   - Компонент индикатора загрузки, заменяющий LoadingSpinner
   - Настраиваемый размер и цвет

3. **QuizLayout** (ui/layout/QuizLayout.tsx)
   - Базовая структура для всех экранов квиза
   - Поддерживает заголовок, подзаголовок, кнопку назад
   - Обеспечивает консистентный лейаут на всех экранах

### Компоненты квиза (components/quiz)

Компоненты, специфичные для функциональности квиза:

1. **Базовые компоненты квиза** (core/)
   - Option - компонент для отображения опций выбора

2. **Шаги квиза** (steps/)
   - Компоненты для каждого этапа квиза, разделенные по категориям:
     - TypeSelectionStep - выбор типа практики
     - Шаги для телесных практик (body/)
     - Шаги для медитации (meditation/)
     - Шаги для дыхания (breathing/)

### Компоненты практики (components/practice)

Компоненты для выполнения выбранной практики:

1. **TimerScreen** (practice/timer/TimerScreen.tsx)
   - Компонент таймера для практик
   - Отображает прогресс, позволяет ставить на паузу

2. **PracticeScreen** (practice/PracticeScreen.tsx)
   - Универсальный экран практики
   - Определяет тип практики и отображает соответствующий интерфейс
   - Интегрирует видео-плеер Kinescope или таймер в зависимости от типа практики

## Архитектурные принципы

1. **Разделение ответственности**
   - UI компоненты отделены от бизнес-логики
   - Компоненты домена сгруппированы по функциональности (квиз, практика)
   - Контексты отвечают за хранение состояния и логику переходов

2. **Переиспользуемость**
   - Базовые UI компоненты (Button, Spinner) созданы для многократного использования
   - Каждый компонент выполняет одну конкретную задачу

3. **Консистентность**
   - Единый подход к наименованиям компонентов
   - Сходная структура папок для компонентов одного типа
   - Общие стили через tailwind с общими utility-классами

4. **Модульность**
   - Каждый компонент живет в своей папке
   - Связанные компоненты группируются в соответствующих директориях
   - Лимит 400-700 строк на файл

## Выявленные проблемы и TODO

1. **Навигация**
   - Кнопки "назад" и "отмена" не работают на всех экранах
   - Необходимо проверить и исправить функцию `prevStep` в PracticeFlowContext

2. **Компоненты**
   - Пустой экран выбора длительности телесной практики (DurationStep)
   - Проверить все компоненты выбора длительности во всех типах практик

3. **Логика отображения практик**
   - Исправлено: медитация → таймер, телесные/дыхательные практики → видеоплеер

## Последняя верификация архитектуры

**Дата**: 04.11.2023
**Статус**: Архитектура в процессе реорганизации, обнаружены проблемы с навигацией и некоторыми компонентами. Требуется тщательное тестирование всех маршрутов и обработчиков.

## Интеграция с Supabase (План)

### База данных

#### Таблицы

1. **practices**
   ```sql
   CREATE TABLE practices (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     name TEXT NOT NULL,
     type TEXT NOT NULL, -- 'body', 'meditation', 'breathing'
     description TEXT,
     duration TEXT, -- формат 'MM:SS'
     difficulty TEXT, -- 'beginner', 'intermediate', 'advanced'
     tags TEXT[],
     category TEXT,
     image_url TEXT,
     video_url TEXT,
     created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
     updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
   );
   ```

2. **user_profiles**
   ```sql
   CREATE TABLE user_profiles (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     telegram_id TEXT UNIQUE NOT NULL,
     username TEXT,
     preferences JSONB,
     created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
     updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
   );
   ```

3. **user_sessions**
   ```sql
   CREATE TABLE user_sessions (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     user_id UUID REFERENCES user_profiles(id),
     practice_id UUID REFERENCES practices(id),
     duration INTEGER, -- в секундах
     completed BOOLEAN DEFAULT false,
     created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
   );
   ```

### Аутентификация

Интеграция с Telegram Mini Apps API:
1. Получение данных пользователя через `initData`
2. Валидация данных на стороне сервера
3. Создание или обновление профиля пользователя в Supabase

### Edge Functions

1. **fetchRecommendations**
   - Получает рекомендации по параметрам квиза
   - Фильтрует практики по типу, длительности, уровню сложности и т.д.

2. **trackCompletion**
   - Отслеживает завершение практики пользователем
   - Обновляет статистику пользователя

3. **updateProfile**
   - Обновляет предпочтения пользователя

## Диаграмма потока пользователя

Поток пользователя строго соответствует диаграмме в `diagram.json`:

1. Главный экран → Выбор типа практики
2. Для каждого типа практики - свой поток:
   - **Телесные**: Тип телесной практики → Продолжительность → Цель → Результат
   - **Дыхательные**: Подход к дыханию → Результат
   - **Медитация**: 
     - Путь "Самостоятельная" → Объект медитации → Таймер
     - Путь "С сопровождением" → Цель медитации → Тема → Таймер

## Проблемы и дальнейшие улучшения

1. **Производительность**
   - Оптимизация загрузки компонентов (React.lazy, динамический импорт)
   - Кэширование данных API

2. **Доступность**
   - Улучшение a11y для всех компонентов
   - Поддержка режима высокой контрастности

3. **Оффлайн режим**
   - Использование Service Workers для кэширования и оффлайн доступа
   - Локальное сохранение прогресса пользователя

4. **Многоязычность**
   - Подготовка к поддержке нескольких языков через i18n

5. **Аналитика**
   - Внедрение аналитики Telegram Mini Apps
   - Отслеживание конверсии и завершения практик

## Дорожная карта разработки

### Спринт 1: Квиз подбора практики ✅
- Создание контекста для хранения состояния подбора
- Разработка компонентов для шагов квиза
- Реализация логики перехода между шагами
- Создание базовых UI-компонентов

### Спринт 2: Рекомендательная система 🟡
- Создание страниц рекомендаций практик
- Реализация таймера для практик
- Интеграция с Telegram Mini Apps API
- Создание страниц с описанием каждого типа практик

### Спринт 3: Персонализация и улучшения 🔴
- Добавление системы избранных практик
- Добавление истории практик
- Улучшение UI/UX на основе обратной связи
- Оптимизация производительности

### Спринт 4: Расширение функционала 🔴
- Добавление новых типов практик
- Интеграция с календарем
- Реализация напоминаний
- Добавление аналитики для пользователя

## Ключевые метрики успеха
- Количество завершенных квизов
- Время, проведенное в практиках
- Регулярность использования приложения
- Разнообразие выбранных практик

## Технические ограничения
- Приложение должно быть оптимизировано для мобильных устройств
- Интерфейс должен учитывать ограничения Telegram Mini Apps
- Максимальный размер приложения должен быть минимизирован для быстрой загрузки

## Приоритеты развития
1. Функциональность подбора практик
2. Удобство использования и интуитивность интерфейса
3. Быстродействие и отзывчивость приложения
4. Расширение базы практик и типов упражнений

